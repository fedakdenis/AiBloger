name: deploy

on:
  workflow_dispatch:
  push:
    branches: [main, develop]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'production' || 'staging' }}
    concurrency: deploy-${{ github.ref_name }}
    steps:
      - name: Deploy via SSH
        run: |
          apk add --no-cache openssh sshpass >/dev/null 2>&1 || sudo apt-get update && sudo apt-get install -y openssh-client sshpass
          SSH_OPTS="-o StrictHostKeyChecking=no"
          ssh $SSH_OPTS -i <(echo "$SSH_KEY") $SSH_USER@$SSH_HOST "mkdir -p /srv/aibloger"
        env:
          SSH_HOST: ${{ secrets.DROPLET_HOST }}
          SSH_USER: ${{ secrets.DROPLET_USER }}
          SSH_KEY: ${{ secrets.DROPLET_SSH_KEY }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          GITHUB_SHA: ${{ github.sha }}