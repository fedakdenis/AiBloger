name: deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'production' || 'staging' }}
    concurrency: deploy-${{ github.ref_name }}
    steps:
      - name: Start ssh-agent and add key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.DROPLET_SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.DROPLET_HOST }}" >> ~/.ssh/known_hosts
          
      - uses: actions/checkout@v4

      - name: Deploy via SSH
        run: |
          apk add --no-cache openssh sshpass >/dev/null 2>&1 || sudo apt-get update && sudo apt-get install -y openssh-client sshpass
          mkdir -p build_artifacts
          echo "IMAGE_TAG=${{ github.sha }}" > build_artifacts/.env
          echo "GHCR_OWNER=${{ github.repository_owner }}" >> build_artifacts/.env
          SSH_OPTS="-o StrictHostKeyChecking=yes"
          ssh $SSH_OPTS $SSH_USER@$SSH_HOST "mkdir -p /srv/aibloger"
          scp $SSH_OPTS docker-compose.yml $SSH_USER@$SSH_HOST:/srv/aibloger/
          scp $SSH_OPTS build_artifacts/.env $SSH_USER@$SSH_HOST:/srv/aibloger/
        env:
          SSH_HOST: ${{ secrets.DROPLET_HOST }}
          SSH_USER: ${{ secrets.DROPLET_USER }}
          SSH_KEY: ${{ secrets.DROPLET_SSH_KEY }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          GITHUB_SHA: ${{ github.sha }}
